<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Prioritized Package Type Coverage Report</title>
    <link rel="icon" href="https://raw.githubusercontent.com/jdecked/twemoji/master/assets/svg/2705.svg" type="image/svg+xml"/>
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-hover: #1557b0;
            --bg-color: #f9fbfc;
            --card-bg: #fff;
            --text-color: #333;
            --text-muted: #666;
            --border-color: #e2e8f0;
            --table-header-bg: #f0f4f8;
            --table-row-even: #fafafa;
            --table-row-hover: #f1f8ff;
            --success-color: #22c55e;
            --shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .preamble {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            font-size: 1rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .preamble ul {
            padding-left: 1.5rem;
            margin: 0;
        }

        .preamble li {
            margin-bottom: 12px;
        }

        .preamble a {
            color: var(--primary-color);
            font-weight: bold;
            text-decoration: none;
        }

        .preamble a:hover {
            text-decoration: underline;
        }

        .github-link {
            text-align: center;
            margin: 20px 0;
            font-size: 1rem;
        }

        .github-link a {
            color: #0066cc;
            text-decoration: none;
        }

        .github-link a:hover {
            text-decoration: underline;
        }

        .controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .controls label {
            font-weight: 600;
            color: var(--text-color);
        }

        .controls input[type="date"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
        }

        .controls select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            min-width: 200px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .table-container {
            max-width: 100%;
            overflow-x: auto;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        table th, table td {
            padding: 12px 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        table th {
            background-color: var(--table-header-bg);
            color: var(--text-color);
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
            white-space: nowrap;
        }

        table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        table tr:hover {
            background-color: var(--table-row-hover);
        }

        .coverage-cell {
            text-align: right;
            padding-right: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .boolean-yes {
            background-color: var(--success-color) !important;
            color: white;
            text-align: center;
            font-weight: 600;
        }

        .boolean-no {
            text-align: center;
            color: var(--text-muted);
        }

        .package-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        .package-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <h1>üì¶ Prioritized Package Type Coverage Report</h1>

    <div class="preamble">
        <ul>
            <li>‚úÖ <strong>Better Reliability:</strong> Type annotations help catch bugs early and improve confidence in your codebase.</li>
            <li>üöÄ <strong>Developer Velocity:</strong> Great type coverage improves editor support, autocompletion, and navigation.</li>
            <li>üìö <strong>Living Documentation:</strong> Type hints clarify APIs without relying solely on comments or docstrings, and they are validated automatically.</li>
            <li>üîç <strong>Community Visibility:</strong> This site tracks the top 2,000 PyPI packages‚Äîstand out by adding great types!</li>
        </ul>
        <ul>
            <li>
                üìà <a href="historical_data/coverage-trends.html">View historical coverage trends</a>
            </li>
            <li>
                ‚ùì Have questions or ideas? 
                <a href="https://github.com/lolpack/type_coverage_py/issues" target="_blank">Leave an issue on GitHub</a>.
            </li>
            <li>
                ‚úçÔ∏è Want to contribute types? 
                <a href="https://github.com/lolpack/type_coverage_py/issues" target="_blank">Find an open issue or start one</a> and make a real impact!
            </li>
        </ul>
    </div>

    <p class="github-link">
        üõ†Ô∏è See code and methodology here: 
        <a href="https://github.com/lolpack/type_coverage_py" target="_blank">https://github.com/lolpack/type_coverage_py</a>
    </p>

    <div class="controls">
        <div>
            <label for="date-picker">üìÖ View historical data: </label>
            <select id="date-picker">
                <option value="">Latest</option>
            </select>
        </div>
    </div>

    <div id="table-container" class="table-container">
        <div class="loading">Loading package data...</div>
    </div>

    <script>
        // Configuration - paths relative to prioritized folder
        const JSON_BASE_PATH = 'historical_data/json/';
        const CURRENT_JSON_PATH = 'package_report.json';

        // Color calculation for coverage percentages
        function getColor(percentage) {
            if (percentage < 0 || percentage === null || percentage === undefined) {
                return 'transparent';
            }
            let red, green;
            if (percentage < 50) {
                red = 255;
                green = Math.floor(255 * (percentage / 50));
            } else {
                red = Math.floor(255 * ((100 - percentage) / 50));
                green = 255;
            }
            return `rgb(${red},${green},55)`;
        }

        // Format percentage for display
        function formatPercentage(value) {
            if (value === null || value === undefined || value === 'N/A') {
                return 'N/A';
            }
            if (typeof value === 'number') {
                if (value < 0) return 'N/A';
                return value.toFixed(2) + '%';
            }
            return value;
        }

        // Create a percentage cell with color
        function createPercentageCell(value) {
            const formatted = formatPercentage(value);
            if (formatted === 'N/A') {
                return `<td class="coverage-cell">N/A</td>`;
            }
            const color = getColor(parseFloat(value));
            return `<td class="coverage-cell" style="background-color: ${color};">${formatted}</td>`;
        }

        // Create a boolean cell
        function createBooleanCell(value) {
            if (value) {
                return `<td class="boolean-yes">Yes</td>`;
            }
            return `<td class="boolean-no">No</td>`;
        }

        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return num.toLocaleString();
        }

        // Render the table with package data
        function renderTable(data) {
            const container = document.getElementById('table-container');
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Ranking</th>
                            <th>Package Name</th>
                            <th>Download Count</th>
                            <th>Has Typeshed</th>
                            <th>Has Stubs Package</th>
                            <th>Has py.typed File</th>
                            <th>Non-Typeshed Stubs</th>
                            <th>Pyright Known Types</th>
                            <th>Pyright Ambiguous Types</th>
                            <th>Pyright Unknown Types</th>
                            <th>Pyright Coverage</th>
                            <th>Parameter Type Coverage</th>
                            <th>Return Type Coverage</th>
                            <th>Parameter Coverage w/ Typeshed</th>
                            <th>Return Type Coverage w/ Typeshed</th>
                            <th>Typeshed-stats Parameter Type Coverage</th>
                            <th>Typeshed-stats Return Type Coverage</th>
                            <th>Typeshed-stats Completeness Level</th>
                            <th>Typeshed-stats Stubtest Strictness</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const [packageName, details] of Object.entries(data)) {
                const coverage = details.CoverageData || {};
                const typeshed = details.TypeshedData || {};
                const pyright = details.pyright_stats || {};

                const paramCoverage = coverage.parameter_coverage;
                const returnCoverage = coverage.return_type_coverage;
                const paramCoverageStubs = coverage.parameter_coverage_with_stubs;
                const returnCoverageStubs = coverage.return_type_coverage_with_stubs;

                const typeshedParam = typeshed['% param'];
                const typeshedReturn = typeshed['% return'];

                let nonTypeshedStubs = details.non_typeshed_stubs || 'N/A';
                if (nonTypeshedStubs !== 'N/A') {
                    nonTypeshedStubs = `<a href="${nonTypeshedStubs}" target="_blank" class="package-link">${packageName}-stubs</a>`;
                }

                html += `
                    <tr>
                        <td>${details.DownloadRanking || 'N/A'}</td>
                        <td>${packageName}</td>
                        <td>${formatNumber(details.DownloadCount)}</td>
                        ${createBooleanCell(details.HasTypeShed)}
                        ${createBooleanCell(details.HasStubsPackage)}
                        ${createBooleanCell(details.HasPyTypedFile)}
                        <td>${nonTypeshedStubs}</td>
                        <td>${pyright.withKnownType || 'N/A'}</td>
                        <td>${pyright.withAmbiguousType || 'N/A'}</td>
                        <td>${pyright.withUnknownType || 'N/A'}</td>
                        ${createPercentageCell(pyright.coverage)}
                        ${createPercentageCell(paramCoverage)}
                        ${createPercentageCell(returnCoverage)}
                        ${createPercentageCell(paramCoverageStubs)}
                        ${createPercentageCell(returnCoverageStubs)}
                        ${createPercentageCell(typeshedParam)}
                        ${createPercentageCell(typeshedReturn)}
                        <td>${typeshed.completeness_level || 'N/A'}</td>
                        <td>${typeshed.stubtest_strictness || 'N/A'}</td>
                    </tr>
                `;
            }

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Load available dates for the date picker
        async function loadAvailableDates() {
            const datePicker = document.getElementById('date-picker');
            
            try {
                // Try to load the dates manifest file
                const response = await fetch('historical_data/json/dates.json');
                if (response.ok) {
                    const dates = await response.json();
                    dates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        datePicker.appendChild(option);
                    });
                } else {
                    console.log('No dates manifest found, using current data only');
                }
            } catch (error) {
                console.error('Error loading dates:', error);
            }
        }

        // Load package data from JSON
        async function loadPackageData(date = null) {
            const container = document.getElementById('table-container');
            container.innerHTML = '<div class="loading">Loading package data...</div>';

            let jsonPath = CURRENT_JSON_PATH;
            if (date) {
                jsonPath = `${JSON_BASE_PATH}package_report-${date}.json`;
            }

            try {
                const response = await fetch(jsonPath);
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status}`);
                }
                const data = await response.json();
                renderTable(data);
            } catch (error) {
                console.error('Error loading package data:', error);
                container.innerHTML = `<div class="loading">Error loading data: ${error.message}</div>`;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAvailableDates();
            await loadPackageData();

            // Set up date picker change handler
            document.getElementById('date-picker').addEventListener('change', (e) => {
                const selectedDate = e.target.value;
                loadPackageData(selectedDate || null);
            });
        });
    </script>
</body>
</html>
